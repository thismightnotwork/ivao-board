<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IVAO Flight Board – EGLL</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; }
    h1 { text-align: center; margin-top: 20px; }
    table { width: 90%; margin: 20px auto; border-collapse: collapse; background: #fff; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #e0e0e0; }
  </style>
</head>
<body>
  <h1>EGLL – <span id="mode">Arrivals</span></h1>
  <table>
    <thead>
      <tr><th>Callsign</th><th>Route</th><th>Est. Time (UTC)</th></tr>
    </thead>
    <tbody id="flights"><tr><td colspan="3">Loading...</td></tr></tbody>
  </table>

<script>
  const airport = 'EGLL';
  let mode = 'arrivals';

  async function getToken() {
    const res = await fetch('https://ivao-token-server.onrender.com/token');
    if (!res.ok) throw new Error('Failed to get token');
    const data = await res.json();
    return data.token;
  }

  async function fetchFlights(token) {
    const url = 'https://api.ivao.aero/v2/tracker/whazzup';
    const res = await fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Accept': 'application/json'
      }
    });
    if (!res.ok) throw new Error('Failed to fetch flights');
    const data = await res.json();

    const flights = data.instances.filter(f =>
      mode === 'arrivals' ? f.arricao === airport : f.depicao === airport
    );

    const rows = flights.slice(0, 20).map(f => {
      const route = mode === 'arrivals' ? f.depicao : f.arricao;
      const time = mode === 'arrivals' ? f.arrivaltime : f.departuretime;
      const timeStr = time ? new Date(time * 1000).toISOString().substr(11, 5) : 'N/A';
      return `<tr><td>${f.callsign}</td><td>${route}</td><td>${timeStr}</td></tr>`;
    }).join('');

    document.getElementById('flights').innerHTML = rows || '<tr><td colspan="3">No flights</td></tr>';
  }

  function toggleMode() {
    mode = (mode === 'arrivals') ? 'departures' : 'arrivals';
    document.getElementById('mode').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
  }

  async function update() {
    try {
      const token = await getToken();
      await fetchFlights(token);
    } catch (e) {
      console.error(e);
      document.getElementById('flights').innerHTML = '<tr><td colspan="3">Error loading data</td></tr>';
    }
  }

  update();
  setInterval(update, 5000);      // Refresh every 5 seconds
  setInterval(() => {
    toggleMode();
    update();
  }, 15000);                     // Switch mode every 15 seconds
</script>
</body>
</html>
