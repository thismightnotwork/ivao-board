<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IVAO Flight Board – EGLL</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; }
    h1 { text-align: center; margin-top: 20px; }
    table { width: 90%; margin: 20px auto; border-collapse: collapse; background: #fff; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #e0e0e0; }
  </style>
</head>
<body>
  <h1>EGLL – <span id="mode">Arrivals</span></h1>
  <table>
    <thead>
      <tr><th>Callsign</th><th>Route</th><th>Est. Time (UTC)</th></tr>
    </thead>
    <tbody id="flights"><tr><td colspan="3">Loading...</td></tr></tbody>
  </table>

<script>
  const airport = 'EGLL';
  let mode = 'arrivals';

  async function getToken() {
    try {
      const res = await fetch('https://ivao-token-server.onrender.com/token');
      if (!res.ok) throw new Error('Token server error: ' + res.status);
      const data = await res.json();
      if (!data.token) throw new Error('No token in response');
      return data.token;
    } catch (e) {
      console.error('Token fetch failed:', e);
      throw e;
    }
  }

  // Convert seconds since midnight to HH:mm string
  function secondsToTime(sec) {
    if (sec === null || sec === undefined) return 'N/A';
    // sec might be a number like 1800 for 00:30 UTC
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
  }

  async function fetchFlights(token) {
    try {
      const url = 'https://api.ivao.aero/v2/tracker/whazzup';
      const res = await fetch(url, {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Accept': 'application/json'
        }
      });
      if (!res.ok) {
        const errText = await res.text();
        console.error('IVAO API error:', res.status, errText);
        throw new Error('Failed to fetch IVAO flight data');
      }

      const data = await res.json();
      console.log('IVAO API response:', data);

      if (!data.clients || !data.clients.pilots) {
        throw new Error('API response missing "clients.pilots" array');
      }

      // Filter flights based on flightPlan departure/arrival
      const flights = data.clients.pilots.filter(f => {
        if (!f.flightPlan) return false;
        if (mode === 'arrivals') {
          return f.flightPlan.arrivalId && f.flightPlan.arrivalId.toUpperCase() === airport;
        } else {
          return f.flightPlan.departureId && f.flightPlan.departureId.toUpperCase() === airport;
        }
      });

      // Create rows
      const rows = flights.slice(0, 20).map(f => {
        const route = mode === 'arrivals' ? f.flightPlan.departureId : f.flightPlan.arrivalId;
        const timeSeconds = mode === 'arrivals' ? f.flightPlan.arrivalTime : f.flightPlan.departureTime;
        const timeStr = secondsToTime(timeSeconds);

        return `<tr><td>${f.callsign}</td><td>${route || 'N/A'}</td><td>${timeStr}</td></tr>`;
      }).join('');

      document.getElementById('flights').innerHTML = rows || '<tr><td colspan="3">No flights</td></tr>';
    } catch (e) {
      console.error('Flight fetch error:', e);
      document.getElementById('flights').innerHTML = '<tr><td colspan="3">Error loading flights</td></tr>';
    }
  }

  function toggleMode() {
    mode = (mode === 'arrivals') ? 'departures' : 'arrivals';
    document.getElementById('mode').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
  }

  async function update() {
    try {
      const token = await getToken();
      await fetchFlights(token);
    } catch (e) {
      document.getElementById('flights').innerHTML = '<tr><td colspan="3">Error getting data</td></tr>';
    }
  }

  update();
  setInterval(() => {
    toggleMode();
    update();
  }, 10000); // toggle mode and update every 10 seconds
</script>
</body>
</html>
