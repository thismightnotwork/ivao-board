<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IVAO Flight Board – EGLL</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; }
    h1 { text-align: center; margin-top: 20px; }
    table { width: 90%; margin: 20px auto; border-collapse: collapse; background: #fff; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #e0e0e0; }
  </style>
</head>
<body>
  <h1>EGLL – <span id="mode">Arrivals</span></h1>
  <table>
    <thead>
      <tr><th>Callsign</th><th>Route</th><th>Est. Time (UTC)</th></tr>
    </thead>
    <tbody id="flights"><tr><td colspan="3">Loading...</td></tr></tbody>
  </table>

<script>
  const airport = 'EGLL';
  let mode = 'arrivals';

  async function getToken() {
    try {
      const res = await fetch('https://ivao-token-server.onrender.com/token');
      if (!res.ok) throw new Error('Token server error: ' + res.status);
      const data = await res.json();
      if (!data.token) throw new Error('No token in response');
      return data.token;
    } catch (e) {
      console.error('Token fetch failed:', e);
      throw e;
    }
  }

  async function fetchFlights(token) {
    try {
      const url = 'https://api.ivao.aero/v2/tracker/whazzup';
      const res = await fetch(url, {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Accept': 'application/json'
        }
      });
      if (!res.ok) {
        const errText = await res.text();
        console.error('IVAO API error:', res.status, errText);
        throw new Error('Failed to fetch IVAO flight data');
      }

      const data = await res.json();
      console.log('IVAO API response:', data); // Debug log

      if (!data.instances) {
        throw new Error('API response missing "instances" array');
      }

      const flights = data.instances.filter(f =>
        mode === 'arrivals' ? f.arricao === airport : f.depicao === airport
      );

      const rows = flights.slice(0, 20).map(f => {
        const route = mode === 'arrivals' ? f.depicao : f.arricao;
        const time = mode === 'arrivals' ? f.arrivaltime : f.departuretime;
        const timeStr = time ? new Date(time * 1000).toISOString().substr(11, 5) : 'N/A';
        return `<tr><td>${f.callsign}</td><td>${route}</td><td>${timeStr}</td></tr>`;
      }).join('');

      document.getElementById('flights').innerHTML = rows || '<tr><td colspan="3">No flights</td></tr>';
    } catch (e) {
      console.error('Flight fetch error:', e);
      document.getElementById('flights').innerHTML = '<tr><td colspan="3">Error loading flights</td></tr>';
    }
  }

  function toggleMode() {
    mode = (mode === 'arrivals') ? 'departures' : 'arrivals';
    document.getElementById('mode').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
  }

  async function update() {
    try {
      const token = await getToken();
      await fetchFlights(token);
    } catch (e) {
      document.getElementById('flights').innerHTML = '<tr><td colspan="3">Error getting data</td></tr>';
    }
  }

  update();
  setInterval(update, 5000);
  setInterval(() => {
    toggleMode();
    update();
  }, 15000);
</script>
</body>
</html>
